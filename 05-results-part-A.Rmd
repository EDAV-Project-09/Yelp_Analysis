# Results-part(A)

In this section, we will detail our analysis to the questions of interest mentioned in the introduction and gain preliminary insights through exploratory data analysis and visualization. We have divided it into four subsections that aim to answer the questions through a variety of different visualization.

Spatial Data Analysis
Demand and Price Analysis
User Review (Textual Data) Mining
Other Interesting Insights

## Spatial Data Analysis ## 

In this part, we will explore some basic variables from our dataset using spatial visualizations and will answer questions relating to density of restaurants, variations in opening or not, and cuisine. We will do all these detailed analysis based on a subset of data in Arizona.

```{r}
library(ggplot2)
library(leaflet)
library(dplyr)
library(readr)
library(stringr)
library(rgdal)
library(ggplot2)
library(tidyverse)
library(lubridate)
```

```{r}
yelp_restaurant_data <- read.csv("yelp_cleaned_data.csv")
yelp_restaurant_data = yelp_restaurant_data[,-1]
yelp_restaurant_data$city <- factor(yelp_restaurant_data$city)
yelp_restaurant_data$state <- factor(yelp_restaurant_data$state)
```

### Whole Dataset ###
Before we are going to show you some interesting findings, let's have a look at our whole data.

```
yelp_grouped <- yelp_restaurant_data %>% group_by(state) %>%
  summarise(long=mean(longitude),lat=mean(latitude),n=n())

leaflet(data = yelp_grouped)%>%
  setView( lat=37, lng=-97 , zoom=4)%>%
  addTiles() %>%
  addCircleMarkers(~long, ~lat,label=~state,radius = ~n/600,stroke=FALSE,fillOpacity=0.5,
                   popup = paste("State: ", yelp_grouped$state,
```

```{r warning=FALSE}
yelp_grouped <- yelp_restaurant_data %>% group_by(state) %>%
  summarise(long=mean(longitude),lat=mean(latitude),n=n())

leaflet(data = yelp_grouped)%>%
  setView( lat=37, lng=-97 , zoom=4)%>%
  addTiles() %>%
  addCircleMarkers(~long, ~lat,label=~state,radius = ~n/600,stroke=FALSE,fillOpacity=0.5,
                   popup = paste("State: ", yelp_grouped$state,
                                 "<br /> Number of samples:", yelp_grouped$n))
```

As we can see, Airbnb only provides data of several cities like Montreal and Waterloo in Canada, Pittsburgh, Charlotte, Urbana-Champaign, Phoenix, Las Vegas, Madison, Cleveland in U.S., so we will focus on a single area to do our analysis, and we decide to use Arizona which includes city Phoenix with biggest dataset.

### Arizona Dataset ###

```
library(rgdal)

# group the data by zipcode:
yelp_AZ_postal<- yelp_AZ %>% group_by(postal_code) %>% summarise(n=n())
yelp_AZ_postal <- yelp_AZ_postal[c(-1,-2),]
names(yelp_AZ_postal) <- c('GEOID10','n')

# Read shapefile:
my_zip <- readOGR( 
  dsn= path.expand("Data/zip_shape") , 
  layer="cb_2018_us_zcta510_500k",
  verbose=FALSE
)

# Create a color palett for the map:
my_zip@data <- left_join(my_zip@data,yelp_AZ_postal,by='GEOID10')
mypalette <- colorNumeric( palette="viridis", domain=my_zip@data$n, na.color="transparent")
mypalette(c(45,43))

# choropleth map:
m <- leaflet(my_zip) %>% 
  addTiles()  %>% 
  setView( lat=33.6, lng=-112 , zoom=9) %>%
  addPolygons( fillColor = ~mypalette(n), stroke=FALSE, fillOpacity=0.5) %>%
  addLegend("topright", pal = mypalette, values = my_zip@data$n, title = "quantity") 
  
m
```

```{r}
yelp_AZ <- yelp_restaurant_data[yelp_restaurant_data$state=='AZ',]
yelp_AZ_postal<- yelp_AZ %>% group_by(postal_code) %>% summarise(n=n())
yelp_AZ_postal <- yelp_AZ_postal[c(-1,-2),]
names(yelp_AZ_postal) <- c('GEOID10','n')

my_zip <- readOGR( 
  dsn= path.expand("Data/zip_shape") , 
  layer="cb_2018_us_zcta510_500k",
  verbose=FALSE
)

my_zip@data <- left_join(my_zip@data,yelp_AZ_postal,by='GEOID10')
mypalette <- colorNumeric( palette="viridis", domain=my_zip@data$n, na.color="transparent")

m <- leaflet(my_zip) %>% 
  addTiles()  %>% 
  setView( lat=33.6, lng=-112 , zoom=9) %>%
  addPolygons( fillColor = ~mypalette(n), stroke=FALSE, fillOpacity=0.5) %>%
  addLegend("topright", pal = mypalette, values = my_zip@data$n, title = "quantity") 

m
```

This is a basic interactive plot with all the restaurants in Arizona grouped in zipcode clusters. You can zoom in and out to see the density distribution. You can further click on each restaurant to see details like Name, address, stars and is open or not. This visualization helps us to basicly understand how restaurants are distributed across zipcode zones. We can see from the map that maximum restaurants are clustered around Tempo, and Scottsdale, followed by some areas around Phoenix, and the area with fewer restaurants are a little bit far from Phoenix city.

Now, because the epidemic is very serious, we really want to know if restaurants are still open. Here, we work with the is_open data within the dataset to see if there is any pattern about opening or not. In this interactive plot, you can click on the circles to see their basic informatin.

```
AZ_palette <- colorFactor(palette='RdYlBu', domain=yelp_AZ$is_open, levels = NULL, ordered = FALSE,
            na.color = "#808080", alpha = FALSE, reverse = FALSE)

leaflet(data = yelp_AZ)%>%
  addTiles() %>%
  addCircleMarkers(~longitude, ~latitude,label=~name,radius = 5,stroke=FALSE, fillColor = ~AZ_palette(is_open),
                   popup = paste("Name: ",yelp_AZ$name,
                                 "<br /> Address:" ,yelp_AZ$address,
                                 '<br /> Stars: ',yelp_AZ$stars,
                                 '<br /> Open: ',yelp_AZ$is_open)) %>%
  addLegend("topright", pal = AZ_palette, values = yelp_AZ$is_open, title = "Is open")
```

```{r}
AZ_palette <- colorFactor(palette='RdYlBu', domain=yelp_AZ$is_open, levels = NULL, ordered = FALSE,
            na.color = "#808080", alpha = FALSE, reverse = FALSE)

leaflet(data = yelp_AZ)%>%
  addTiles() %>%
  addCircleMarkers(~longitude, ~latitude,label=~name,radius = 5,stroke=FALSE, fillColor = ~AZ_palette(is_open),
                   popup = paste("Name: ",yelp_AZ$name,
                                 "<br /> Address:" ,yelp_AZ$address,
                                 '<br /> Stars: ',yelp_AZ$stars,
                                 '<br /> Open: ',yelp_AZ$is_open)) %>%
  addLegend("topright", pal = AZ_palette, values = yelp_AZ$is_open, title = "Is open")
```

From the plot, it is easy find differences between open restaurants and closed restaurants. For example, there are more open restaurants than closed restaurants, and they are more widely distributed. Also, closed restaurants are mostly concentrated in the city or town centers. This makes sense, because these areas are more dangerous than other areas, thus people may tend to suspend business to protect themselves. And since there are more restaurants located there, the probability of being closed must be lager than in other areas.

It is interesting to observe these patterns, and if you are living in Phoenix, you may have some deeper and personal findings from this graph. 

What we are also interested in is how the ratings are related with geographic data. We all know that people can rate restaurants on Yelp, and if we want to find somewhere to eat, we must notice that score. The stars more or less influenced our decisions.

```
star_palette <- colorNumeric(palette="plasma", domain=yelp_AZ$stars, na.color="transparent")

leaflet(data = yelp_AZ)%>%
  addTiles() %>%
  addCircleMarkers(~longitude, ~latitude,label=~name,radius = 5,stroke=FALSE,fillColor = ~star_palette(stars),
                   popup = paste("Name: ",yelp_AZ$name,
                                 "<br /> Address:" ,yelp_AZ$address,
                                 '<br /> Stars: ',yelp_AZ$stars,
                                 '<br /> Open: ',yelp_AZ$is_open)) %>%
  addLegend("topright", pal = star_palette, values = yelp_AZ$stars, title = "Stars")
```

```{r}
star_palette <- colorNumeric(palette="plasma", domain=yelp_AZ$stars, na.color="transparent")

leaflet(data = yelp_AZ)%>%
  addTiles() %>%
  addCircleMarkers(~longitude, ~latitude,label=~name,radius = 5,stroke=FALSE,fillColor = ~star_palette(stars),
                   popup = paste("Name: ",yelp_AZ$name,
                                 "<br /> Address:" ,yelp_AZ$address,
                                 '<br /> Stars: ',yelp_AZ$stars,
                                 '<br /> Open: ',yelp_AZ$is_open)) %>%
  addLegend("topright", pal = star_palette, values = yelp_AZ$stars, title = "Stars")
```

The graph shows that the centre of Phoenix, a small area in Tempo, Scottsdale, and the upright area in AZ have more stars. Glendale, and unexpectly, area between Phoenix and Tempo have least stars. Interestingly, if we zoom in the map, we will find that the restaurants with very few stars are all in an airport called 'Phoenix Sky Harbor International Airport'. (And now it seems make sense :)

After we have seen the overall distribution, we may have question: Is the star distriburion related to the cuisine? We choose the top3 amount cuisines and let's have a look.

```
bool_american <- str_detect(yelp_AZ$country,'american')
yelp_AZ_american <- yelp_AZ[bool_american,]
yelp_AZ_american <- subset(yelp_AZ_american,!is.na(yelp_AZ_american$business_id))


leaflet(data = yelp_AZ_american)%>%
  addTiles() %>%
  addCircleMarkers(~longitude, ~latitude,label=~name,radius = 5,stroke=FALSE,fillColor = ~star_palette(stars),
                   popup = paste("Name: ",yelp_AZ_american$name,
                                 "<br /> Address:" ,yelp_AZ_american$address,
                                 '<br /> Stars: ',yelp_AZ_american$stars,
                                 '<br /> Open: ',yelp_AZ_american$is_open)) %>%
  addLegend("topright", pal = star_palette, values = yelp_AZ_american$stars, title = "Stars")
```

```{r}
bool_american <- str_detect(yelp_AZ$country,'american')
yelp_AZ_american <- yelp_AZ[bool_american,]
yelp_AZ_american <- subset(yelp_AZ_american,!is.na(yelp_AZ_american$business_id))


leaflet(data = yelp_AZ_american)%>%
  addTiles() %>%
  addCircleMarkers(~longitude, ~latitude,label=~name,radius = 5,stroke=FALSE,fillColor = ~star_palette(stars),
                   popup = paste("Name: ",yelp_AZ_american$name,
                                 "<br /> Address:" ,yelp_AZ_american$address,
                                 '<br /> Stars: ',yelp_AZ_american$stars,
                                 '<br /> Open: ',yelp_AZ_american$is_open)) %>%
  addLegend("topright", pal = star_palette, values = yelp_AZ_american$stars, title = "Stars")
```

```{r}
bool_mexican = str_detect(yelp_AZ$country,'mexican')
yelp_AZ_mexican = yelp_AZ[bool_mexican,]
yelp_AZ_mexican <- subset(yelp_AZ_mexican,!is.na(yelp_AZ_mexican$business_id))


leaflet(data = yelp_AZ_mexican)%>%
  addTiles() %>%
  addCircleMarkers(~longitude, ~latitude,label=~name,radius = 5,stroke=FALSE,fillColor = ~star_palette(stars),
                   popup = paste("Name: ",yelp_AZ_mexican$name,
                                 "<br /> Address:" ,yelp_AZ_mexican$address,
                                 '<br /> Stars: ',yelp_AZ_mexican$stars,
                                 '<br /> Open: ',yelp_AZ_mexican$is_open)) %>%
  addLegend("topright", pal = star_palette, values = yelp_AZ_mexican$stars, title = "Stars")
```

```{r}
bool_chinese = str_detect(yelp_AZ$country,'chinese')
yelp_AZ_chinese = yelp_AZ[bool_chinese,]
yelp_AZ_chinese <- subset(yelp_AZ_chinese,!is.na(yelp_AZ_chinese$business_id))

leaflet(data = yelp_AZ_chinese)%>%
  addTiles() %>%
  addCircleMarkers(~longitude, ~latitude,label=~name,radius = 5,stroke=FALSE,fillColor = ~star_palette(stars),
                   popup = paste("Name: ",yelp_AZ_chinese$name,
                                 "<br /> Address:" ,yelp_AZ_chinese$address,
                                 '<br /> Stars: ',yelp_AZ_chinese$stars,
                                 '<br /> Open: ',yelp_AZ_chinese$is_open)) %>%
  addLegend("topright", pal = star_palette, values = yelp_AZ_chinese$stars, title = "Stars")
```
We found that different cuisines actually have similar score distributions. The star may be more related to location than cuisine. Let us look at the overall distribution of cuisine in AZ. Here we choose the top9 amount cuisines.

```{r}
yelp_country <- yelp_AZ[,c('name','address','stars','is_open','country','latitude','longitude')]
country <- str_extract(yelp_AZ$country,'[a-z]+')
yelp_country$country <- country
country_filter <- str_detect(yelp_country$country,'american|mexican|chinese|italian|japanese|mediterranean|indian|thai|french|canadian')
yelp_country <- yelp_country[country_filter,]
yelp_country <- subset(yelp_country,!is.na(yelp_country$country))

country_palette <- colorFactor(palette='Paired', domain=yelp_country$country, levels = NULL, ordered = FALSE,
                          na.color = "#808080", alpha = FALSE, reverse = FALSE)

leaflet(data = yelp_country)%>%
  addTiles() %>%
  addCircleMarkers(~longitude, ~latitude,label=~name,radius = 5,stroke=FALSE, fillColor = ~country_palette(country),
                   popup = paste("Name: ",yelp_country$name,
                                 "<br /> Address:" ,yelp_country$address,
                                 '<br /> Stars: ',yelp_country$stars,
                                 '<br /> Open: ',yelp_country$is_open)) %>%
  addLegend("topright", pal = country_palette, values = yelp_country$country, title = "Cuisine")
```

This plot shows clearly that there are some clusters of mexican restaurants, american restaurants are located everywhere, chinese restaurants have a trend to the downright, while indian are mostly located on the top and downright.


## Time Analysis ##

The following plot shows how opening hours are different from different days in a week.

```{r}
yelp_time <- yelp_restaurant_data[,c(1,25:38)]
yelp_time <- na.omit(yelp_time)
yelp_time_tidy <- yelp_time %>% pivot_longer(cols=!business_id,names_to='week',values_to='time')

yelp_time_tidy$time2 <- lead(yelp_time_tidy$time,1)
yelp_time_tidy <- yelp_time_tidy[seq(from=1, to=nrow(yelp_time_tidy), by=2),]
week <- str_extract(yelp_time_tidy$week,'[a-z]+')
yelp_time_tidy$week <- week
yelp_time_tidy$time <- strptime(yelp_time_tidy$time,'%Y-%m-%d %H:%M:%S')
yelp_time_tidy$time2 <- strptime(yelp_time_tidy$time2,'%Y-%m-%d %H:%M:%S')

yelp_time_tidy$'0' <- ifelse((hour(yelp_time_tidy$time) <= 0)&(hour(yelp_time_tidy$time2) >= 0),1,0)
yelp_time_tidy$'1' <- ifelse((hour(yelp_time_tidy$time) <= 1)&(hour(yelp_time_tidy$time2) >= 1),1,0)
yelp_time_tidy$'2' <- ifelse((hour(yelp_time_tidy$time) <= 2)&(hour(yelp_time_tidy$time2) >= 2),1,0)
yelp_time_tidy$'3' <- ifelse((hour(yelp_time_tidy$time) <= 3)&(hour(yelp_time_tidy$time2) >= 3),1,0)
yelp_time_tidy$'4' <- ifelse((hour(yelp_time_tidy$time) <= 4)&(hour(yelp_time_tidy$time2) >= 4),1,0)
yelp_time_tidy$'5' <- ifelse((hour(yelp_time_tidy$time) <= 5)&(hour(yelp_time_tidy$time2) >= 5),1,0)
yelp_time_tidy$'6' <- ifelse((hour(yelp_time_tidy$time) <= 6)&(hour(yelp_time_tidy$time2) >= 6),1,0)
yelp_time_tidy$'7' <- ifelse((hour(yelp_time_tidy$time) <= 7)&(hour(yelp_time_tidy$time2) >= 7),1,0)
yelp_time_tidy$'8' <- ifelse((hour(yelp_time_tidy$time) <= 8)&(hour(yelp_time_tidy$time2) >= 8),1,0)
yelp_time_tidy$'9' <- ifelse((hour(yelp_time_tidy$time) <= 9)&(hour(yelp_time_tidy$time2) >= 9),1,0)
yelp_time_tidy$'10' <- ifelse((hour(yelp_time_tidy$time) <= 10)&(hour(yelp_time_tidy$time2) >= 10),1,0)
yelp_time_tidy$'11' <- ifelse((hour(yelp_time_tidy$time) <= 11)&(hour(yelp_time_tidy$time2) >= 11),1,0)
yelp_time_tidy$'12' <- ifelse((hour(yelp_time_tidy$time) <= 12)&(hour(yelp_time_tidy$time2) >= 12),1,0)
yelp_time_tidy$'13' <- ifelse((hour(yelp_time_tidy$time) <= 13)&(hour(yelp_time_tidy$time2) >= 13),1,0)
yelp_time_tidy$'14' <- ifelse((hour(yelp_time_tidy$time) <= 14)&(hour(yelp_time_tidy$time2) >= 14),1,0)
yelp_time_tidy$'15' <- ifelse((hour(yelp_time_tidy$time) <= 15)&(hour(yelp_time_tidy$time2) >= 15),1,0)
yelp_time_tidy$'16' <- ifelse((hour(yelp_time_tidy$time) <= 16)&(hour(yelp_time_tidy$time2) >= 16),1,0)
yelp_time_tidy$'17' <- ifelse((hour(yelp_time_tidy$time) <= 17)&(hour(yelp_time_tidy$time2) >= 17),1,0)
yelp_time_tidy$'18' <- ifelse((hour(yelp_time_tidy$time) <= 18)&(hour(yelp_time_tidy$time2) >= 18),1,0)
yelp_time_tidy$'19' <- ifelse((hour(yelp_time_tidy$time) <= 19)&(hour(yelp_time_tidy$time2) >= 19),1,0)
yelp_time_tidy$'20' <- ifelse((hour(yelp_time_tidy$time) <= 20)&(hour(yelp_time_tidy$time2) >= 20),1,0)
yelp_time_tidy$'21' <- ifelse((hour(yelp_time_tidy$time) <= 21)&(hour(yelp_time_tidy$time2) >= 21),1,0)
yelp_time_tidy$'22' <- ifelse((hour(yelp_time_tidy$time) <= 22)&(hour(yelp_time_tidy$time2) >= 22),1,0)
yelp_time_tidy$'23' <- ifelse((hour(yelp_time_tidy$time) <= 23)&(hour(yelp_time_tidy$time2) >= 23),1,0)

yelp_time_grouped <- yelp_time_tidy %>% 
  group_by(week) %>% 
  summarise(`0` = length(which(`0`==1)),`1` = length(which(`1`==1)),
            `2` = length(which(`2`==1)),`3` = length(which(`3`==1)),
            `4` = length(which(`4`==1)),`5` = length(which(`5`==1)),
            `6`= length(which(`6`==1)),`7` = length(which(`7`==1)),
            `8`= length(which(`8`==1)),`9` = length(which(`9`==1)),
            `10` = length(which(`10`==1)),`11` = length(which(`11`==1)),
            `12` = length(which(`12`==1)),`13` = length(which(`13`==1)),
            `14` = length(which(`14`==1)),`15` = length(which(`15`==1)),
            `16` = length(which(`16`==1)),`17` = length(which(`17`==1)),
            `18` = length(which(`18`==1)),`19` = length(which(`19`==1)),
            `20` = length(which(`20`==1)),`21` = length(which(`21`==1)),
            `22` = length(which(`22`==1)),`23` = length(which(`23`==1)),)


yelp_time_tidy_final <- yelp_time_grouped %>% pivot_longer(cols=!week,names_to='timeofday',values_to='count')

yelp_time_tidy_final$week <- factor(yelp_time_tidy_final$week,levels=c('monday','tuesday','wednesday','thursday','friday','saturday','sunday'))
yelp_time_tidy_final$timeofday <- factor(yelp_time_tidy_final$timeofday,levels=c('0','1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','23'))
yelp_time_tidy_final %>%
  ggplot(aes(week,count))+
  geom_col(width=0.5)+
  xlab("time of day")+
  ylab("day of week")+
  ggtitle("Open hours of a day")+
  theme(plot.title=element_text(face="bold",hjust=0.4),axis.text.x=element_text(size=7,angle=30))+
  facet_wrap(~timeofday)
```

